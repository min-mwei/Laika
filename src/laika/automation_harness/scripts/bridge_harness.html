<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Laika Automation Harness</title>
    <style>
      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        margin: 20px;
        color: #1f2a3a;
      }
      h1 {
        margin: 0 0 8px;
        font-size: 18px;
      }
      #status {
        font-size: 14px;
        margin-bottom: 12px;
        color: #4a5b70;
      }
      #log {
        border: 1px solid #d6e2f1;
        border-radius: 6px;
        padding: 10px;
        background: #f7f9fc;
        font-family: "SF Mono", SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
        font-size: 12px;
        white-space: pre-wrap;
      }
    </style>
  </head>
  <body>
    <h1>Laika Automation Harness</h1>
    <div id="status">Loading scenario...</div>
    <div id="log"></div>

    <script>
      (function () {
        "use strict";

        var statusEl = document.getElementById("status");
        var logEl = document.getElementById("log");
        var pageOrigin = window.location.origin || "";
        var runId = null;
        var nonce = null;
        var scenario = null;
        var reportUrl = null;
        var configTimeoutSeconds = null;
        var ackReceived = false;
        var runDone = false;
        var readyReceived = false;
        var readyCount = 0;
        var lastReadyAt = null;
        var startAttempts = 0;
        var startTimer = null;
        var startRetryMs = 750;
        var maxStartAttempts = 120;
        var startDeadlineAt = null;

        function log(message) {
          var line = typeof message === "string" ? message : JSON.stringify(message, null, 2);
          logEl.textContent += line + "\n";
        }

        function setStatus(text) {
          statusEl.textContent = text;
        }

        function sendTelemetry(type, detail) {
          var payload = {
            type: type,
            runId: runId,
            at: new Date().toISOString(),
            detail: detail || null
          };
          fetch("/api/telemetry", {
            method: "POST",
            headers: { "content-type": "application/json" },
            body: JSON.stringify(payload)
          }).catch(function () {
            return null;
          });
        }

        function isRetryableStartError(error) {
          return error === "runner_unavailable" ||
            error === "no_sender_tab" ||
            error === "message_failed" ||
            error === "runtime_unavailable" ||
            error === "reset_failed" ||
            error === "storage_unavailable" ||
            error === "storage_clear_failed" ||
            error === "start_failed";
        }

        function postAutomationStart() {
          if (!scenario || !nonce) {
            return;
          }
          startAttempts += 1;
          sendTelemetry("start_sent", { attempt: startAttempts });
          var options = scenario.options && typeof scenario.options === "object"
            ? Object.assign({}, scenario.options)
            : {};
          if (configTimeoutSeconds && typeof options.runTimeoutMs !== "number") {
            options.runTimeoutMs = Math.max(1, configTimeoutSeconds - 30) * 1000;
          }
          window.postMessage({
            type: "laika.automation.start",
            runId: runId,
            goals: scenario.goals || [],
            goal: scenario.goal || "",
            targetUrl: scenario.url || "",
            options: options,
            nonce: nonce,
            reportUrl: reportUrl
          }, pageOrigin);
        }

        function scheduleStartRetry() {
          if (ackReceived || runDone) {
            return;
          }
          if (startAttempts >= maxStartAttempts) {
            setStatus("Automation start timed out.");
            sendTelemetry("start_timeout", { attempts: startAttempts });
            runDone = true;
            stopStartRetry();
            reportResult({
              runId: runId,
              scenario: scenario,
              error: "start_timeout",
              source: "page",
              receivedAt: new Date().toISOString()
            }).catch(function () {
              log({ event: "report_failed" });
            });
            return;
          }
          if (startDeadlineAt && Date.now() > startDeadlineAt) {
            setStatus("Automation start timed out.");
            sendTelemetry("start_timeout", { attempts: startAttempts });
            runDone = true;
            stopStartRetry();
            reportResult({
              runId: runId,
              scenario: scenario,
              error: "start_timeout",
              source: "page",
              receivedAt: new Date().toISOString()
            }).catch(function () {
              log({ event: "report_failed" });
            });
            return;
          }
          postAutomationStart();
          startTimer = window.setTimeout(scheduleStartRetry, startRetryMs);
        }

        function stopStartRetry() {
          if (startTimer) {
            window.clearTimeout(startTimer);
            startTimer = null;
          }
        }

        function reportResult(payload) {
          return fetch("/api/report", {
            method: "POST",
            headers: { "content-type": "application/json" },
            body: JSON.stringify(payload)
          });
        }

        window.addEventListener("message", function (event) {
          if (!event || event.source !== window || event.origin !== pageOrigin) {
            return;
          }
          var data = event.data || {};
          if (!data.type || typeof data.type !== "string") {
            return;
          }
          if (data.nonce && nonce && data.nonce !== nonce) {
            return;
          }
          if (data.type === "laika.automation.ready") {
            readyReceived = true;
            readyCount += 1;
            lastReadyAt = data.at || new Date().toISOString();
            setStatus("Extension ready. Starting...");
            log({ event: "ready", at: lastReadyAt });
            sendTelemetry("ready", { at: lastReadyAt });
            if (!ackReceived && !runDone) {
              stopStartRetry();
              postAutomationStart();
              startTimer = window.setTimeout(scheduleStartRetry, startRetryMs);
            }
            return;
          }
          if (data.type === "laika.automation.ack") {
            setStatus("Automation started: " + (data.runId || "unknown"));
            log({ event: "ack", runId: data.runId });
            sendTelemetry("ack", { runId: data.runId });
            ackReceived = true;
            stopStartRetry();
            return;
          }
          if (data.type === "laika.automation.status") {
            setStatus("Status: " + (data.status || "unknown"));
            log({ event: "status", status: data.status, runId: data.runId });
            sendTelemetry("status", { runId: data.runId, status: data.status });
            return;
          }
          if (data.type === "laika.automation.progress") {
            log({ event: "progress", runId: data.runId, goal: data.goal, step: data.step && data.step.step });
            sendTelemetry("progress", { runId: data.runId, goal: data.goal, step: data.step && data.step.step });
            return;
          }
          if (data.type === "laika.automation.result") {
            setStatus("Completed");
            log({ event: "result", runId: data.runId });
            sendTelemetry("result", { runId: data.runId });
            runDone = true;
            stopStartRetry();
            reportResult({
              runId: data.runId,
              scenario: scenario,
              result: data.result,
              source: "page",
              receivedAt: new Date().toISOString()
            }).catch(function () {
              log({ event: "report_failed" });
            });
            return;
          }
          if (data.type === "laika.automation.error") {
            if (!ackReceived && isRetryableStartError(data.error || "")) {
              log({ event: "error_retry", runId: data.runId, error: data.error });
              sendTelemetry("error_retry", { runId: data.runId, error: data.error });
              return;
            }
            var errorDetails = data.errorDetails && typeof data.errorDetails === "object"
              ? data.errorDetails
              : null;
            setStatus("Error: " + (data.error || "unknown"));
            log({ event: "error", runId: data.runId, error: data.error, errorDetails: errorDetails });
            sendTelemetry("error", { runId: data.runId, error: data.error, errorDetails: errorDetails });
            runDone = true;
            stopStartRetry();
            reportResult({
              runId: data.runId,
              scenario: scenario,
              error: data.error,
              errorDetails: errorDetails,
              source: "page",
              receivedAt: new Date().toISOString()
            }).catch(function () {
              log({ event: "report_failed" });
            });
          }
        });

        fetch("/api/config")
          .then(function (response) {
            return response.json();
          })
          .then(function (config) {
            scenario = config.scenario || null;
            runId = config.runId || null;
            nonce = config.nonce || null;
            reportUrl = pageOrigin ? pageOrigin + "/api/report" : null;
            if (typeof config.timeoutSeconds === "number" && config.timeoutSeconds > 0) {
              configTimeoutSeconds = config.timeoutSeconds;
              startDeadlineAt = Date.now() + (config.timeoutSeconds * 1000);
              maxStartAttempts = Math.max(maxStartAttempts, Math.ceil((config.timeoutSeconds * 1000) / startRetryMs));
            }
            if (!scenario || !scenario.url) {
              setStatus("Invalid scenario config");
              return;
            }
            setStatus("Scenario loaded. Starting...");
            log({ event: "config", scenario: scenario.url, goals: (scenario.goals || []).length });
            sendTelemetry("config_loaded", { scenario: scenario.url });
            scheduleStartRetry();
          })
          .catch(function (error) {
            setStatus("Failed to load config");
            log({ event: "config_error", error: String(error) });
          });
      })();
    </script>
  </body>
</html>
